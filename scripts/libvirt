#!/bin/bash
# Manage VM nodes which have a specific set of hardware attributes.

VM_CPU=${VM_CPU:-1}
VM_MEMORY=${VM_MEMORY:-2048}
VM_DISK=${VM_DISK:-10}

MASTER_VM_CPU=${MASTER_VM_CPU:-2}
MASTER_VM_MEMORY=${MASTER_VM_MEMORY:-2048}
MASTER_VM_DISK=${MASTER_VM_DISK:-50}

GPU_WORKER_VM_CPU=${GPU_WORKER_VM_CPU:-2}
GPU_WORKER_VM_MEMORY=${GPU_WORKER_VM_MEMORY:-8096}
GPU_WORKER_VM_DISK=${GPU_WORKER_VM_DISK:-50}

WORKER_VM_CPU=${WORKER_VM_CPU:-2}
WORKER_VM_MEMORY=${WORKER_VM_MEMORY:-2048}
WORKER_VM_DISK=${WORKER_VM_DISK:-50}

if [ "$EUID" -ne 0 ]
  then echo "Please run as root"
  exit
fi

function main {
  case "$1" in
    "create") create_docker;;
    "create-docker") create_docker;;
    "create-rkt") create_rkt;;
    "create-uefi") create_uefi;;
    "start") start;;
    "reboot") reboot;;
    "shutdown") shutdown;;
    "poweroff") poweroff;;
    "destroy") destroy;;
    *)
      usage
      exit 2
      ;;
  esac
}

function usage {
  echo "USAGE: ${0##*/} <command>"
  echo "Commands:"
  echo -e "\tcreate\t\tcreate QEMU/KVM nodes on a rkt CNI metal0 bridge"
  echo -e "\tcreate-rkt\tcreate QEMU/KVM nodes on a rkt CNI metal0 bridge"
  echo -e "\tcreate-docker\tcreate QEMU/KVM nodes on the docker0 bridge"
  echo -e "\tcreate-uefi\tcreate UEFI QEMU/KVM nodes on the docker0 bridge"
  echo -e "\tstart\t\tstart the QEMU/KVM nodes"
  echo -e "\treboot\t\treboot the QEMU/KVM nodes"
  echo -e "\tshutdown\tshutdown the QEMU/KVM nodes"
  echo -e "\tpoweroff\tpoweroff the QEMU/KVM nodes"
  echo -e "\tdestroy\t\tdestroy the QEMU/KVM nodes"
}

COMMON_VIRT_OPTS="--memory=${VM_MEMORY} --vcpus=${VM_CPU} --disk pool=default,size=${VM_DISK} --os-type=linux --os-variant=generic --noautoconsole --events on_poweroff=preserve"

MASTER_COMMON_VIRT_OPTS="--memory=${MASTER_VM_MEMORY} --vcpus=${MASTER_VM_CPU} --disk pool=default,size=${MASTER_VM_DISK} --os-type=linux --os-variant=generic --noautoconsole --events on_poweroff=preserve"

GPU_WORKER_COMMON_VIRT_OPTS="--memory=${GPU_WORKER_VM_MEMORY} --vcpus=${GPU_WORKER_VM_CPU} --disk pool=default,size=${GPU_WORKER_VM_DISK} --os-type=linux --os-variant=generic --noautoconsole --events on_poweroff=preserve"

WORKER_COMMON_VIRT_OPTS="--memory=${WORKER_VM_MEMORY} --vcpus=${WORKER_VM_CPU} --disk pool=default,size=${WORKER_VM_DISK} --os-type=linux --os-variant=generic --noautoconsole --events on_poweroff=preserve"


NODE1_NAME=node1001
NODE1_MAC=52:54:00:a1:9c:ae

NODE2_NAME=node1002
NODE2_MAC=52:54:00:b2:2f:86

NODE3_NAME=node1003
NODE3_MAC=52:54:00:c3:61:77

#NODE4_NAME=node1004
#NODE4_MAC=52:54:00:d7:99:d9

function create_docker {
  virt-install --name $NODE1_NAME --network=bridge:docker0,mac=$NODE1_MAC $COMMON_VIRT_OPTS --boot=hd,network
  virt-install --name $NODE2_NAME --network=bridge:docker0,mac=$NODE2_MAC $COMMON_VIRT_OPTS --boot=hd,network
  virt-install --name $NODE3_NAME --network=bridge:docker0,mac=$NODE3_MAC $COMMON_VIRT_OPTS --boot=hd,network
  #virt-install --name $NODE4_NAME --network=bridge:docker0,mac=$NODE4_MAC $COMMON_VIRT_OPTS --boot=hd,network
}

function create_rkt {
  virt-install --name $NODE1_NAME --network=bridge:metal0,mac=$NODE1_MAC $COMMON_VIRT_OPTS --boot=hd,network
  virt-install --name $NODE2_NAME --network=bridge:metal0,mac=$NODE2_MAC $COMMON_VIRT_OPTS --boot=hd,network
  virt-install --name $NODE3_NAME --network=bridge:metal0,mac=$NODE3_MAC $COMMON_VIRT_OPTS --boot=hd,network
  #virt-install --name $NODE4_NAME --network=bridge:metal0,mac=$NODE4_MAC $COMMON_VIRT_OPTS --boot=hd,network
}

function create_uefi {
  virt-install --name $NODE1_NAME --network=bridge=docker0,model=e1000,mac=$NODE1_MAC $MASTER_COMMON_VIRT_OPTS --boot=hd,uefi,network
  virt-install --name $NODE2_NAME --network=bridge=docker0,model=e1000,mac=$NODE2_MAC $GPU_WORKER_COMMON_VIRT_OPTS --boot=hd,uefi,network --host-device 17:00.0 --cpu host --features kvm_hidden=on --graphics none
  virt-install --name $NODE3_NAME --network=bridge=docker0,model=e1000,mac=$NODE3_MAC $WORKER_COMMON_VIRT_OPTS --boot=hd,uefi,network
  #virt-install --name $NODE4_NAME --network=bridge=docker0,model=e1000,mac=$NODE4_MAC $COMMON_VIRT_OPTS --boot=hd,uefi,network
}

#nodes=(node1001 node1002 node1003 node1004)
nodes=(node1001 node1002 node1003)

function start {
  for node in ${nodes[@]}; do
    virsh start $node
  done
}

function reboot {
  for node in ${nodes[@]}; do
    virsh reboot $node
  done
}

function shutdown {
  for node in ${nodes[@]}; do
    virsh shutdown $node
  done
}

function poweroff {
  for node in ${nodes[@]}; do
    virsh destroy $node
  done
}

function destroy {
  for node in ${nodes[@]}; do
    virsh destroy $node
  done
  for node in ${nodes[@]}; do
    virsh undefine $node
  done
  virsh pool-refresh default
  for node in ${nodes[@]}; do
    virsh vol-delete --pool default $node.qcow2
  done
}

main $@
